---
title: 'Prisma ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®è‹¦åŠ´'
emoji: 'ğŸ”–'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['prisma']
published: false
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã€ŒMedleyï¼ˆãƒ¡ãƒ‰ãƒ¬ãƒ¼ï¼‰ Advent Calendar 2024ã€5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ï¼

https://qiita.com/advent-calendar/2024/medley

ã“ã‚“ã«ã¡ã¯ã€ãƒ¡ãƒ‰ãƒ¬ãƒ¼ã®äººæãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æœ¬éƒ¨ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹æ‰‹å¶‹ã§ã™ã€‚
ç§ãŒé–‹ç™ºã‚’æ‹…å½“ã—ã¦ã„ã‚‹[ã‚¸ãƒ§ãƒ–ãƒ¡ãƒ‰ãƒ¬ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼](https://jm-academy.jp/)ã§ã¯ ORM ã« Prisma ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ãã® Prisma ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã«å–ã‚Šçµ„ã‚“ã æ™‚ã®è©¦è¡ŒéŒ¯èª¤ã—ãŸã“ã¨ã‚„å­¦ã³ã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# Prisma ã¨ã¯

ã©ã†ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã®ã‹æ›¸ã

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã«æ°—ã‚’ã¤ã‘ã‚‹ã“ã¨

ä»Šã¾ã§ã€æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚ˆã†ãªä¸»è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã‚’ã‚„ã£ãŸçµŒé¨“ãŒãªã‹ã£ãŸã®ã§ã€ã©ã®ã‚ˆã†ãªã“ã¨ã«æ°—ã‚’ã¤ã‘ã¦å®Ÿæ–½ã™ã¹ãã‹èª¿ã¹ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

Prisma ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã« [Upgrade guides](https://www.prisma.io/docs/orm/more/upgrade-guides) ãŒã‚ã‚Šã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ™‚ã®æ‰‹é †ã‚‚è¨˜è¼‰ã•ã‚Œã¦ã„ã¦åŠ©ã‹ã‚Šã¾ã—ãŸã€‚
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ã€å‰å›ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸ PRã€ãƒãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ã‚‚åŠ©è¨€ã‚’ã‚‚ã‚‰ã„ã€ä»¥ä¸‹ã«æ³¨æ„ã—ã¦é€²ã‚ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

- ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’èª­ã¿ã€Breaking Changeï¼ˆç ´å£Šçš„å¤‰æ›´ï¼‰ã‚„ã€æ–°ã—ããƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæ©Ÿèƒ½ã‚’ç¢ºèªã™ã‚‹
- ãƒªãƒªãƒ¼ã‚¹ç›´å¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„ã€x.x.0 ã¯æ–°ã—ã„ãƒã‚°ãŒç™ºè¦‹ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€ä¸€ã¤å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã—ã¦ãŠã
- `prisma` ã¨ `@prisma/client` ã©ã¡ã‚‰ã‚‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æƒãˆã‚‹å¿…è¦ãŒã‚ã‚‹

# ä»Šå›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ä¸€ç•ªãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆ

ä»Šå›ã¯ 5.9.1ï¼ˆä»Šå¹´ 2 æœˆãƒªãƒªãƒ¼ã‚¹ï¼‰ã‹ã‚‰ã®ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã ã£ãŸã®ã‚‚ã‚ã‚Šã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’èª­ã‚€é™ã‚Šã§ã¯ Breaking Change ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã—ã‹ã—ã€ã„ã–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æ—¥æ™‚ãŒé–¢ã‚ã‚‹ãƒ†ã‚¹ãƒˆã®ä¸€éƒ¨ãŒå¤±æ•—ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## èµ·ããŸäº‹è±¡ï¼š `$queryRaw` ã§å–å¾—ã—ãŸ Date å‹ã®å€¤ã«å·®ãŒå‡ºãŸ

Prisma ã® `$queryRaw` ã¯ç”Ÿã® SQL ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã§ã™ã€‚Date å‹ã‚’å€¤ã‚’å–å¾—ã™ã‚‹ SQL ã‚’`$queryRaw`ã§å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ–°æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§çµæœã«å·®ãŒå‡ºã¾ã—ãŸã€‚

```typescript
const result = await prisma.$queryRaw`
  SELECT '2024-10-01 10:00:00'::timestamp
`;
console.log(result);

// 9æ™‚é–“ãƒã‚¤ãƒŠã‚¹ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ
æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³: [ { timestamp: 2024-10-01T10:00:00.000Z } ]
æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³: [ { timestamp: 2024-10-01T01:00:00.000Z } ]
```

## èª¿æŸ»ã—ãŸã“ã¨

<!-- ã“ã® èª¬æ˜ã§ä¼ã‚ã‚‹ã®ã‹ï¼Ÿå®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¨ã‹è©³ç´°ãŒå¿…è¦ã ã¨ã™ã‚‹ã¨ã€ãã®ã¾ã¾è¼‰ã›ã¦ã„ã„ã®ã‹-->
<!-- å‰æã¨ã—ã¦ã€ã¯æ®µè½åˆ†ã‘ãŸæ–¹ãŒã„ã„ï¼Ÿ -->

å‰æã¨ã—ã¦ã€Prisma ã§æ—¥æ™‚ã‚’ä¿å­˜ã™ã‚‹ã¨ã€DB ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®šã«é–¢ã‚ã‚‰ãšã€UTC æ™‚é–“ ã«å¤‰æ›ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ãã®ãŸã‚ã‚¸ãƒ§ãƒ–ãƒ¡ãƒ‰ãƒ¬ãƒ¼ã‚¢ã‚«ãƒ‡ãƒŸãƒ¼ã§ã¯ Prisma ã® middleware ã‚’ä½œæˆã—ã¦ã€DB ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿(where ã‚„ data ãªã©)ã« Date å‹ã®ã‚‚ã®ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã«å¯¾ã—ã¦ 9 æ™‚é–“ãƒ—ãƒ©ã‚¹ã€DB ã‹ã‚‰å‡ºåŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã« Date å‹ã®ã‚‚ã®ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã«å¯¾ã—ã¦ 9 æ™‚é–“ãƒã‚¤ãƒŠã‚¹ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```TypeScript
import { PrismaClient } from '@prisma/client';
import { addHours, addMinutes, subHours, subMinutes } from 'date-fns';
import { clone } from 'ramda';

function getTimezoneOffset(): {
  hours: number;
  minutes: number;
} {
  const date = new Date();
  const offset = -date.getTimezoneOffset();
  return {
    hours: Math.floor(offset / 60),
    minutes: offset % 60,
  };
}

const offset = getTimezoneOffset();

function addTimezoneOffset(date: Date): Date {
  return addMinutes(addHours(date, offset.hours), offset.minutes);
}

function subtractTimezoneOffset(date: Date): Date {
  return subMinutes(subHours(date, offset.hours), offset.minutes);
}

function isPrimitive(value: unknown): boolean {
  return (
    (typeof value !== 'object' && typeof value !== 'function') || value === null
  );
}

function recursivelyTransformDateData(
  obj: Record<string, unknown>,
  transform: (date: Date) => Date,
): void {
  if (!obj) {
    return;
  }

  Object.keys(obj).forEach((key) => {
    const element = obj[key];
    if (element instanceof Date) {
      obj[key] = transform(element);
      return;
    }
    if (isPrimitive(element)) {
      return;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    recursivelyTransformDateData(element as any, transform);
  });
}

function absorbTimezoneDifference<T>(
  value: T,
  transform: (date: Date) => Date,
): T {
  if (value instanceof Date) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    return transform(value) as any;
  }
  if (isPrimitive(value)) {
    return value;
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  recursivelyTransformDateData(value as any, transform);
  return value;
}

// @see: https://github.com/medley-inc/academy/pull/258
export function applyAbsorbTimezoneDifferenceMiddleware(
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  client: PrismaClient<any>,
): void {
  client.$use(async (params, next) => {
    params.args = absorbTimezoneDifference(
      clone(params.args),
      addTimezoneOffset,
    );

    const result = await next(params);

    return absorbTimezoneDifference(result, subtractTimezoneOffset);
  });
}
```

ã“ã®ãŸã‚ã€middleware å†…éƒ¨ã®å‡¦ç†ãŒæ–°æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å¤‰åŒ–ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹èª¿ã¹ã‚‹ãŸã‚ã«ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```TypeScript
export function applyAbsorbTimezoneDifferenceMiddleware(
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  client: PrismaClient<any>,
): void {
  client.$use(async (params, next) => {
    console.log('absorbTimezoneDifferenceã«æ¸¡ã™å‰ã®params.args', params.args);
    params.args = absorbTimezoneDifference(
      clone(params.args),
      addTimezoneOffset,
    );
    console.log('absorbTimezoneDifferenceã«æ¸¡ã—ãŸå¾Œã®params.args', params.args);
    const result = await next(params);
    console.log('nextå®Ÿè¡Œå¾Œ', result);
    const result2 = absorbTimezoneDifference(result, subtractTimezoneOffset);
    console.log('nextå®Ÿè¡Œå¾ŒabsorbTimezoneDifferenceã®çµæœ', result2);
    return result2;
  });
}

```

- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒãŠã‹ã—ã„ã¨ã‚¢ã‚¿ãƒªã‚’ã¤ã‘ã¦ã€èª¿æŸ»ã—ãŸã“ã¨æ›¸ã
  ãªã‚“ã§ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒæ€ªã—ã„ã¨æ€ã£ãŸã®ã‹ã‚‚æ›¸ã

## ä½•ãŒåŸå› ã ã£ãŸã‹

- èª¿æŸ»ã—ãŸçµæœã€ã“ã“ãŒã“ã†ãªã£ã¦ãŸã¨æ›¸ã
- queryRaw ã®çµæœã¯æ—¥ä»˜ãªã©ã‚’æ–‡å­—åˆ—ã§è¿”ã—ã¦ãŸãŒ Date å‹ã‚’è¿”ã™ã‚ˆã†ã«ãªã‚ŠãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã® Date å‹ã®åˆ†å²ã«å…¥ã‚‹ã‚ˆã†ã«ãªã£ãŸã‹ã‚‰æ™‚å·®ãŒè£œæ­£ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ

## å¯¾å¿œã—ãŸã“ã¨

ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«ã‚„ã£ãŸã“ã¨ã€å‹•ä½œç¢ºèªã¨ã‹
åŸå› è§£æ±ºã®ãŸã‚ã«å¯¾å¿œã—ãŸã“ã¨
ãƒ†ã‚¹ãƒˆè¿½åŠ ã—ãŸ

# ãŠã‚ã‚Šã«

ç´†ä½™æ›²æŠ˜ã‚ã‚Šã¾ã—ãŸãŒã€ç„¡äº‹ Prisma ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãŒã§ãã¾ã—ãŸã€‚
ä»Šå›ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆã¯ Prisma ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’ middleware ã§è§£æ¶ˆã—ã¦ã„ã‚‹å ´åˆã«ã®ã¿èµ·ã“ã‚‹äº‹è±¡ã§ã™ãŒã€å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ï¼

æ˜æ—¥ã¯ã€ãƒ»ãƒ»ãƒ»
