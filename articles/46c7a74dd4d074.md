---
title: "TerraformåˆæœŸè¨­å®šã®å‚™å¿˜éŒ²"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform"]
published: true
publication_name: "x_point_1"
---

æ–°è¦é–‹ç™ºã§ã®Terraformã®åˆæœŸè¨­å®šã«æ‰‹ã“ãšã£ãŸã®ã§ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚


# ç›®æ¨™
#### 1. tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ã«ä¿å­˜ã™ã‚‹è¨­å®š
#### 2. é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ã®S3ã®ä½œæˆ
#### 3. CloudFrontã®ä½œæˆ

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

å…¨ã¦ã®è¨­å®šã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’è€ƒæ…®ã—ã¦ã€ãƒªã‚½ãƒ¼ã‚¹ã”ã¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã¦ã„ã¾ã™ã€‚

```
terraform/
â”œâ”€â”€ .gitignore/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ cloudfront.tf
â”‚   â”œâ”€â”€ s3.tf
â”‚   â””â”€â”€ variables.tf
â””â”€â”€ envs/
    â”œâ”€â”€ dev/
    â”‚   â””â”€â”€ main.tf
    â”œâ”€â”€ stg/
    â”‚   â””â”€â”€ main.tf
    â””â”€â”€ prd/
        â””â”€â”€ main.tf

```
é–‹ç™ºãŒé€²ã‚€ã«ã¤ã‚Œã¦ã€å¿…è¦ã«å¿œã˜ã¦æ–°ãŸãªAWSãƒªã‚½ãƒ¼ã‚¹ã®è¨­å®šã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ãŒã€åˆæœŸè¨­å®šã¨ã—ã¦ã¯ä¸Šè¨˜ã§å•é¡Œãªã‹ã£ãŸã§ã™ã€‚


# 1. tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ã«ä¿å­˜ã™ã‚‹è¨­å®š

## S3ãƒã‚±ãƒƒãƒˆã‚’æ‰‹å‹•ã§ä½œæˆ

tfstateãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆTerraformã®çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã®ä¿å­˜å…ˆã§ã‚ã‚‹ãƒã‚±ãƒƒãƒˆã¯äº‹å‰ã«å­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§ä½¿ç”¨ã™ã‚‹S3ãƒã‚±ãƒƒãƒˆã¯AWSã®ãƒãƒãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§ä½œæˆã—ã¾ã™ã€‚


## AWS Providerã®è¨­å®š

AWSã‚’Terraformã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚
æ‰‹å‹•ã§ä½œæˆã—ãŸS3ãƒã‚±ãƒƒãƒˆã¯ã“ã“ã§ä¿å­˜å…ˆã«è¨­å®šã•ã‚Œã¾ã™ã€‚

```HCL:envs/dev/main.tf
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦S3ã‚’é¸æŠã€‚Terraformã®çŠ¶æ…‹ç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtfstateï¼‰ãŒS3ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã•ã‚Œã‚‹ã€‚
terraform {
  backend "s3" {
    bucket = "æ‰‹å‹•ã§ä½œæˆã—ãŸS3ãƒã‚±ãƒƒãƒˆå"
    key    = "terraform.tfstate"
    region = "ap-northeast-1"
  }
}

# AWSã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦æŒ‡å®šã€‚
provider "aws" {
  region = "ap-northeast-1"
}

# commonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã€‚è¨­å®šã¯ã€Œ../../commonã€ã«æ ¼ç´ã•ã‚ŒãŸTerraformè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚Œã‚‹ã€‚
module "common" {
  source   = "../../common"
  env_name = "dev"  # å¤‰æ•°ã¨ã—ã¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…éƒ¨ã§åˆ©ç”¨ã§ãã‚‹ã€‚ç’°å¢ƒã«åˆã‚ã›ã¦stg,prdã«å¤‰æ›´ã€‚
}

```
## â€»ãŠã¾ã‘
```HCL:.gitignore
.terraform  # ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ã€Œterraform initã€ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
terraform.tfstate.d  # tfstateãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã‚ã‚Š
```


# 2. é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ã®S3ã®ä½œæˆ

```HCL:s3.tf
resource "aws_s3_bucket" "for_client" {
  bucket_prefix = "ä½•ã‚‰ã‹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹"  # æŒ‡å®šã—ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§å§‹ã¾ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒã‚±ãƒƒãƒˆåã‚’ä½œæˆ
}


# ãƒã‚±ãƒƒãƒˆã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©
resource "aws_s3_bucket_policy" "for_client" {
  bucket = aws_s3_bucket.for_client.id
  policy = data.aws_iam_policy_document.for_client.json
}


# AWS IAMãƒãƒªã‚·ãƒ¼ã®JSONãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
data "aws_iam_policy_document" "for_client" {
  statement {
    sid    = "Allow CloudFront"  # ãƒãƒªã‚·ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®è­˜åˆ¥å­
    effect = "Allow"  # ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã§è¨±å¯ã•ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    # ã‚¢ã‚¯ã‚»ã‚¹å…ƒã®è¨­å®š
    principals {
      type        = "AWS"
      identifiers = [aws_cloudfront_origin_access_identity.for_client.iam_arn]  # CloudFrontã«é©ç”¨
    }
    # ãƒã‚±ãƒƒãƒˆã«å¯¾ã—ã¦åˆ¶å¾¡ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
    actions = ["s3:GetObject"]  # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿å–ã‚Šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‚
    # ã‚¢ã‚¯ã‚»ã‚¹å…ˆã®è¨­å®š
    resources = [
      "${aws_s3_bucket.for_client.arn}/*"  # ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨
    ]
  }
}

```
æ–°ã—ã„S3ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã€ãã®ãƒã‚±ãƒƒãƒˆã«CloudFrontã‚’é€šã˜ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—ã®ã¿ã‚’è¨±å¯ã™ã‚‹è¨­å®šã‚’ã—ã¦ã„ã¾ã™ã€‚


# 3. CloudFrontã®ä½œæˆ
ã¡ã‚‡ã£ã¨é•·ã„ã§ã™ã€‚
```HCL:cloudfront.tf
resource "aws_cloudfront_distribution" "cf" {
  # Route53ã§CloudFrontã‚’ã‚¨ã‚¤ãƒªã‚¢ã‚¹å…ˆã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€æ—¢ã«ç®¡ç†ã—ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã§CloudFrontã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
  # aliases = "ãƒ‰ãƒ¡ã‚¤ãƒ³å"  # æœªè¨­å®šãªã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

  # é…ä¿¡ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…ƒï¼ˆã“ã“ã§ã¯S3ãƒã‚±ãƒƒãƒˆï¼‰ã‚’æŒ‡å®š
  origin {
    domain_name = aws_s3_bucket.for_client.bucket_regional_domain_name
    origin_id   = aws_s3_bucket.for_client.id
    s3_origin_config {
      origin_access_identity = aws_cloudfront_origin_access_identity.for_client.cloudfront_access_identity_path
    }
  }

  enabled             = true  # é…ä¿¡ã‚’æœ‰åŠ¹
  is_ipv6_enabled     = true  # IPv6ã‚’æœ‰åŠ¹
  default_root_object = "index.html"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ«ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‹•ä½œã‚’å®šç¾©
  default_cache_behavior {
    allowed_methods  = ["GET", "HEAD"]
    cached_methods   = ["GET", "HEAD"]
    target_origin_id = aws_s3_bucket.for_client.id

    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ä¸€ç·’ã«ã‚ªãƒªã‚¸ãƒ³ã‚µãƒ¼ãƒãƒ¼ï¼ˆS3ãƒã‚±ãƒƒãƒˆï¼‰ã«é€ã‚‹æƒ…å ±ã‚’æŒ‡å®š
    forwarded_values {
      query_string = false

      cookies {
        forward = "none"
      }
    }

    viewer_protocol_policy = "redirect-to-https"  # HTTPSé€šä¿¡ã®ã¿è¨±å¯ã™ã‚‹ã€‚

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®TTLè¨­å®š
    min_ttl     = 0  # 0s
    default_ttl = 86400  # Cache-Control or Expires ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«ç„¡ã„æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®TTLã€‚1æ—¥ã€‚
    max_ttl     = 31536000  # 365æ—¥
  }


  # åœ°ç†çš„ãªåˆ¶é™ã‚’è¨­å®šã€‚noneãªã®ã§åˆ¶é™ãªã—ã€‚
  restrictions {
    geo_restriction {
      restriction_type = "none"
    }
  }

  # SSLè¨¼æ˜æ›¸ã®è¨­å®š
  viewer_certificate {
    cloudfront_default_certificate = true  # CloudFrontãŒæä¾›ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®SSLè¨¼æ˜æ›¸ã‚’ä½¿ç”¨
    # ACMã§ä½œæˆã—ãŸè¨¼æ˜æ›¸ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ãã®å ´åˆcloudfront_default_certificateã¯falseã«ã™ã‚‹ã€‚
    # acm_certificate_arn            = aws_acm_certificate.cert.arn  # æœªè¨­å®šãªã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    ssl_support_method       = "sni-only"
    minimum_protocol_version = "TLSv1"
  }

  # ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ"403: Forbidden"ã®æ™‚ã«"/"ã«200ã§é£›ã°ã™ï¼‰
  custom_error_response {
    error_code         = 403  # Cloudfrontâ†’S3ã®æ§‹æˆã§å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å©ãã¨403ã‚¨ãƒ©ãƒ¼
    response_code      = 200
    response_page_path = "/"
  }
}

# CloudFrontãŒã‚ªãƒªã‚¸ãƒ³ï¼ˆS3ãƒã‚±ãƒƒãƒˆï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
resource "aws_cloudfront_origin_access_identity" "for_client" {}
```

# æ„Ÿæƒ³
Terraformã¯ã¾ã ã¾ã è¨­å®šã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã€ã“ã¨ã«å¿…è¦ãªè¨­å®šã‚’ä»Šå›æ·±æ˜ã‚Šã§ãã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚

# å‚è€ƒ
https://katsuya-place.com/terraform-cloudfront/
https://dev.classmethod.jp/articles/static-web-with-cf-s3-tf/
https://zenn.dev/redgosho/articles/13b93d2a8eac0f

