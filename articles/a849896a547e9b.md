---
title: "ãƒ†ã‚¹ãƒˆã—ã‚„ã™ããƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚‰ã€ã„ã‚ã„ã‚ã†ã‚Œã—ã‹ã£ãŸ"
emoji: "ğŸ§ª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Test", "Python", "SQL"]
published: false
# publication_name: "x_point_1"
---
# ã¯ã˜ã‚ã«
é–‹ç™ºã‚’ã—ã¦ã„ã¦ã€ã€Œã‚ã‚Œã€ãƒ†ã‚¹ãƒˆã—ã«ãã„ãªãƒ»ãƒ»ãƒ»ã€ã¨æ€ã†ã“ã¨ãŒã‚ã‚Šã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ããªã‚‹ã‚ˆã†ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã¿ã‚‹ã¨ã€ã„ã‚ã„ã‚ãƒ¡ãƒªãƒƒãƒˆã‚’æ„Ÿã˜ã‚‹ã“ã¨ãŒã§ããŸã®ã§å…±æœ‰ã—ã¾ã™ï¼

# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ã®çŠ¶æ…‹

## Lambdaæœ¬ä½“
```python:lambda_function.py
def lambda_handler(event, context):
    try:
        # eventã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        query_params = event.get("queryStringParameters")
        user_id = int(query_params.get("id")) if query_params.get("id") else None
        first_name = ãƒ»ãƒ»ãƒ»
        last_name = ãƒ»ãƒ»ãƒ»
        prefecture = ãƒ»ãƒ»ãƒ»
        address = ãƒ»ãƒ»ãƒ»
        phone_number = ãƒ»ãƒ»ãƒ»

        # ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
        records = []
        for user in execute_sql(
            sql="å®Ÿè¡Œã—ãŸã„SQLæ–‡",
            params={  # SQLæ–‡å†…ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«æ¸¡ã™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
                "user_id": id,
                "first_name": first_name,
                "last_name": last_name,
                "prefecture": prefecture,
                "address": address,
                "phone_number": phone_number,
            },
        ):
            records.append(user)

        response = {
            "statusCode": 200,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps(records),
        }
        ã€œã€œã€œï¼ˆçœç•¥ï¼‰ã€œã€œã€œ
```
ä¸Šè¨˜ã¯ã€AWS Lambdaã§å®Ÿè£…ã•ã‚ŒãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ç”»é¢ç­‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã™ã‚‹APIã®ä¸€éƒ¨ã§ã™ã€‚
 `execute_sqlé–¢æ•°` ã¯SQLæ–‡ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã€ãã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€ï¼ˆä½•ã‹å–å¾—ã™ã‚‹SQLã§ã‚ã‚Œã°ï¼‰çµæœã‚’ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã§è¿”ã™é–¢æ•°ã§ã™ã€‚
 `execute_sqlé–¢æ•°` ã«æ¸¡ã™ `å®Ÿè¡Œã—ãŸã„SQLæ–‡` ã¯ä»¥ä¸‹ã§ã™ã€‚

## Lambdaã§å®Ÿè¡Œã—ãŸã„SQLæ–‡
```sql:get_user.sql
SELECT
    id,
    first_name,
    last_name,
    prefecture,
    address,
    phone_number
FROM
    users
WHERE
    ((%(id)s IS NULL) OR (id = %(id)s))
    AND
    ((%(first_name)s IS NULL) OR (first_name LIKE CONCAT('%%', %(first_name)s, '%%')))
    AND
    ((%(last_name)s IS NULL) OR (last_name LIKE CONCAT('%%', %(last_name)s, '%%')))
    AND
    ((%(prefecture)s IS NULL) OR (prefecture = %(prefecture)s))
    AND
    ((%(address)s IS NULL) OR (address LIKE CONCAT('%%', %(address)s, '%%')))
    AND
    ((%(phone_number)s IS NULL) OR (phone_number = %(phone_number)s))
ORDER BY
    id DESC
```
SQLã‚¯ã‚¨ãƒªå†…ã® `%(id)s` ã®ã‚ˆã†ãªè¡¨è¨˜ã¯ã€Pythonã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€SQLã‚¯ã‚¨ãƒªã®ä¸€éƒ¨ã‚’å¾Œã‹ã‚‰å‹•çš„ã«ç½®æ›ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```python:test_get_users.py
def test_get_users():
    from lambda_function import lambda_handler

    # 200
    event = {
        "queryStringParameters": {
            "id": "1",
            "firstName": "å¤ªéƒ",
            "lastName": "å±±ç”°",
            "prefecture": "æ±äº¬éƒ½",
            "address": "æ¸‹è°·åŒº1-1-1",
            "phone_number": "09012345678",
        }
    }

    expected = 200
    result = lambda_handler(event, None)
    assert expected == result["statusCode"]  # assertã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã§çµæœã‚’æ¤œè¨¼
```
ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯LambdaãŒè¿”ã™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã¦ã„ã¾ã™ãŒã€SQLå†…éƒ¨ã®æ¡ä»¶åˆ†å²ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒç¶²ç¾…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
å®Ÿéš›ã¯ã€eventã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å¢—ã‚„ã›ã°ç¶²ç¾…ã§ãã‚‹ã®ã§ã™ãŒã€ã€Œã¡ã‚‡ã£ã¨ãƒ†ã‚¹ãƒˆã—ã«ãã„ãªãƒ»ãƒ»ãƒ»ã€ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ã“ã®æ™‚ã«æ„Ÿã˜ãŸã€Œãƒ†ã‚¹ãƒˆã®å›°é›£ã•ã€ã¯ã€ŒLambdaãŒSQLå®Ÿè¡Œéƒ¨åˆ†ã‚’å«ã‚“ã§ã„ã¦ã€è²¬å‹™ãŒåˆ†ã‘ã‚‰ã‚Œã¦ã„ãªã„ã€ã¤ã¾ã‚Šã€**å˜ä¸€è²¬ä»»ã®åŸå‰‡**ã«åã—ã¦ã„ã‚‹ã‹ã‚‰ã ã¨å¾Œã§ã‚ã‹ã‚Šã¾ã—ãŸã€‚
:::details å˜ä¸€è²¬ä»»ã®åŸå‰‡ã¨ã¯
ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚¯ãƒ©ã‚¹ã¾ãŸã¯é–¢æ•°ã¯ã€å˜ä¸€ã®æ©Ÿèƒ½ã«ã¤ã„ã¦è²¬ä»»ã‚’æŒã¡ã€ ãã®æ©Ÿèƒ½ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹ã¹ãã§ã‚ã‚‹ã€‚
:::


Lambdaå…¨ä½“ã®ãƒ†ã‚¹ãƒˆã«åŠ ãˆã¦ã€SQLã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹éƒ¨åˆ†ã‚‚ãƒ†ã‚¹ãƒˆã—ãŸã„ã¨è€ƒãˆã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã—ãŸã€‚


# ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®é©ç”¨

## Lambdaæœ¬ä½“
```python:lambda_function.py
# æ–°ãŸã«ä½œæˆ
def get_users(
        self,
        *,
        user_id: int = None,
        first_name: str = None,
        last_name: str = None,
        prefecture: str = None,
        address: str = None,
        phone_number: str = None,
    ) -> Generator[mysql.connector.cursor.RowType, None, None]:
        for user in execute_sql(
            sql="å®Ÿè¡Œã—ãŸã„SQLæ–‡",
            params={
                "id": user_id,
                "first_name": first_name,
                "last_name": last_name,
                "prefecture": prefecture,
                "address": address,
                "phone_number": phone_number,
            },
        ):
            yield user

def lambda_handler(event, context):
    try:
        # eventã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        ã€œã€œã€œï¼ˆçœç•¥ï¼‰ã€œã€œã€œ

        # get_usersã§ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
        records = []
        for user in get_users(
            user_id=user_id,
            first_name=first_name,
            last_name=last_name,
            prefecture=prefecture,
            address=address,
            phone_number=phone_number,
        ):
            records.append(user)

        response = {
            "statusCode": 200,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps(records),
        }
        ã€œã€œã€œï¼ˆçœç•¥ï¼‰ã€œã€œã€œ
```
SQLå®Ÿè¡Œéƒ¨åˆ†ã‚’ `get_usersé–¢æ•°` ã«ç‹¬ç«‹ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

## è¿½åŠ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
`get_usersé–¢æ•°` ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ã§ãã€SQLã®å†…éƒ¨ã®æ¡ä»¶åˆ†å²ã‚’ç¶²ç¾…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

```python:test_get_users.py
def test_get_users():
    from lambda_function import get_users

    # ã‚¹ã‚¿ãƒƒãƒ•ID
    assert 1 == len(list(get_users(user_id=1)))

    # åå®Œå…¨ä¸€è‡´
    assert 1 == len(list(get_users(first_name="èŠ±å­")))

    # åéƒ¨åˆ†ä¸€è‡´
    assert 3 == len(list(get_users(first_name="å­")))

    # å§“å®Œå…¨ä¸€è‡´
    assert 2 == len(list(get_users(last_name="å±±ç”°")))

    # å§“éƒ¨åˆ†ä¸€è‡´
    assert 4 == len(list(get_users(last_name="å±±")))

    # å§“åå®Œå…¨ä¸€è‡´
    assert 1 == len(list(get_users(first_name="å¤ªéƒ", last_name="å±±ç”°")))

    # éƒ½é“åºœçœŒ
    assert 3 == len(list(get_users(prefecture="åŒ—æµ·é“")))

    # ä½æ‰€å®Œå…¨ä¸€è‡´
    assert 1 == len(list(get_users(address="æœ­å¹Œå¸‚16-16-16")))

    # ä½æ‰€éƒ¨åˆ†ä¸€è‡´
    assert 3 == len(list(get_users(address="æœ­å¹Œå¸‚")))

    # é›»è©±ç•ªå·
    assert 1 == len(list(get_users(phone_number="09012345678")))
```
# ã¾ã¨ã‚
ä»Šå›ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šã†ã‚Œã—ã‹ã£ãŸã“ã¨

1. ãƒ†ã‚¹ãƒˆç¶²ç¾…æ€§ã®å‘ä¸Šï¼š `get_usersé–¢æ•°` ã¯SQLã®å®Ÿè¡Œã¨ãã®çµæœã‚’è¿”ã™å½¹å‰²ã‚’æŒã¡ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Lambdaå…¨ä½“ã®ãƒ†ã‚¹ãƒˆã ã‘ã§ãªãã€SQLã®å®Ÿè¡Œéƒ¨åˆ†ã«ã¤ã„ã¦å€‹åˆ¥ã«ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒå®¹æ˜“ã«ãªã‚Šã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã®ç¶²ç¾…æ€§ãŒå‘ä¸Šã—ã€å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ­£ã—ãSQLã«é©ç”¨ã•ã‚Œã‚‹ã‹ã€æœŸå¾…é€šã‚Šã®çµæœã‚’è¿”ã™ã‹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

2. å¯èª­æ€§ã®å‘ä¸Šï¼š `get_usersé–¢æ•°` ã‚’è¦‹ã‚‹ã ã‘ã§ã€ä½•ã‚’ã™ã‚‹ãŸã‚ã®é–¢æ•°ã§ã‚ã‚‹ã‹ãŒç†è§£ã—ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚SQLã®å®Ÿè¡Œã«å¿…è¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ˜ç¤ºçš„ã«é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ç¤ºã•ã‚Œã¦ãŠã‚Šã€ãã‚Œã‚‰ãŒã©ã®ã‚ˆã†ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‹ãŒä¸€ç›®ç­ç„¶ã§ã™ã€‚ï¼ˆå˜ä¸€è²¬ä»»ã®åŸå‰‡ã®é©ç”¨ï¼‰

3. å†åˆ©ç”¨æ€§ã®å‘ä¸Šï¼š `get_usersé–¢æ•°` ã‚’åˆ‡ã‚Šå‡ºã™ã“ã¨ã§ã€åŒã˜ãƒ¦ãƒ¼ã‚¶å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä»–ã®ç®‡æ‰€ã§ã‚‚å†åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’è¤‡æ•°ç®‡æ‰€ã«æ›¸ãå¿…è¦ãŒãªããªã‚Šã€ä¿å®ˆæ€§ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚

ã‚ˆã„çµŒé¨“ãŒã§ãã¾ã—ãŸğŸ™ŒğŸ»
