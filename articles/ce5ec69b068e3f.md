---
title: 'Prismaのタイムゾーン問題とバージョンをあげる時の注意点'
emoji: '🌏'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['prisma']
published: false
---

# はじめに

この記事は「Medley（メドレー） Advent Calendar 2024」5 日目の記事です！

https://qiita.com/advent-calendar/2024/medley

こんにちは、メドレーの人材プラットフォーム本部でエンジニアをしている手嶋です。私が開発を担当している[ジョブメドレーアカデミー](https://jm-academy.jp/)では、ORM に [Prisma](https://www.prisma.io/) を使用しています。普段はプロダクト改善を目的とした機能開発を担当していますが、今回はプロダクトを支える主要なライブラリである Prisma のバージョンアップに挑戦しました。その際に直面した課題やハマりポイントを共有したいと思います。

<!--
# バージョンアップ時に気をつけること

今まで、本番コードで使用しているような主要なライブラリのバージョンアップをやった経験がなかったので、どのようなことに気をつけて実施すべきか調べることにしました。

Prisma は公式ドキュメントに [Upgrade guides](https://www.prisma.io/docs/orm/more/upgrade-guides) があり、バージョンアップ時の手順も記載されていて助かりました。
公式ドキュメントや、前回バージョンアップした PR、チームのメンバーにも助言をもらい、以下に注意して進めることにしました。

- リリースノートを読み、Breaking Change（破壊的変更）や、新しくリリースされた機能を確認する
- リリース直後のバージョンや、x.x.0 は新しいバグが発見される場合があるため、一つ前のバージョンにしておく
- `prisma` と `@prisma/client` どちらもバージョンを揃える必要がある -->

# Prisma のタイムゾーン問題について

今回のバージョンアップでは、Prisma のタイムゾーン問題に対応するための実装が意図しない挙動になっていました。そのため、まずは Prisma のタイムゾーン問題について説明します。

Prisma を使用して日時を保存する場合、DB のタイムゾーン設定が JST であっても、日時データは常に UTC 時間で保存されます。この仕様に関する問題は、約 4 年前から Issue が上がっていますが、2024 年 12 月現在も解決されていない状態です。

https://github.com/prisma/prisma/issues/5051

上記の問題については、本来であれば DB に UTC 時間で保存すれば解決する話です。しかし、ジョブメドレーアカデミーは別の会社から運営を引き継いだ経緯があり、DB 内の日時データがすでに JST 時間で保存されていました。そのため、JST での保存を継続して運用する必要がありました。

## どのように対応しているか

タイムゾーン問題に対しては、先ほど紹介した [issue のコメント](https://github.com/prisma/prisma/issues/5051#issuecomment-878106427)にある実装を参考に対応しています。よく使われているワークアラウンドの一つだと思います。

具体的には、Prisma にデータを渡す際と受け取る際に、 UTC と JST の時差を調整するための [Prisma Middleware](https://www.prisma.io/docs/orm/prisma-client/client-extensions/middleware) を作成しています。

# 今回のバージョンアップで直面した問題

今回は 5.9.1（今年 2 月リリース）からのマイナーバージョンのアップデートだったのもあり、リリースノートを読む限りでは Breaking Change はありませんでした。しかし、いざバージョンを上げてテストを実行すると、日時が関わるテストの一部が失敗するようになりました。

## 起きた事象： `$queryRaw` で取得した Date 型の値に差が出た

以下のように新旧バージョンで結果に差が出ました。

```typescript
const result = await prisma.$queryRaw`
  SELECT '2024-10-01 10:00:00'::timestamp
`;
console.log(result);

// 9時間マイナスされるようになった
旧バージョン: [ { timestamp: 2024-10-01T10:00:00.000Z } ]
新バージョン: [ { timestamp: 2024-10-01T01:00:00.000Z } ]
```

## 調査したこと

<!-- この 説明で伝わるのか？実際のコードとか詳細が必要だとすると、そのまま載せていいのか-->
<!-- 前提として、は段落分けた方がいい？ -->

前提として、Prisma で日時を保存すると、DB のタイムゾーン設定に関わらず、UTC 時間 に変換されて保存されてしまいます。そのためジョブメドレーアカデミーでは Prisma の middleware を作成して、DB に渡すデータ(where や data など)に Date 型のものが含まれていれば、それに対して 9 時間プラス、DB から出力されたデータに Date 型のものが含まれていれば、それに対して 9 時間マイナスするようにしています。

このため、middleware 内部の処理が新旧バージョンで変化しているかどうか調べるためにログを追加しました。

```TypeScript
export function applyAbsorbTimezoneDifferenceMiddleware(
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  client: PrismaClient<any>,
): void {
  client.$use(async (params, next) => {
    console.log('absorbTimezoneDifferenceに渡す前のparams.args', params.args);
    params.args = absorbTimezoneDifference(
      clone(params.args),
      addTimezoneOffset,
    );
    console.log('absorbTimezoneDifferenceに渡した後のparams.args', params.args);
    const result = await next(params);
    console.log('next実行後', result);
    const result2 = absorbTimezoneDifference(result, subtractTimezoneOffset);
    console.log('next実行後absorbTimezoneDifferenceの結果', result2);
    return result2;
  });
}

```

- ミドルウェアがおかしいとアタリをつけて、調査したこと書く
  なんでミドルウェアが怪しいと思ったのかも書く

## 何が原因だったか

- ログの結果をはる
- 調査した結果、ここがこうなってたと書く
- queryRaw の結果は日付などを文字列で返してたが Date 型を返すようになりミドルウェアの Date 型の分岐に入るようになったから時差が補正されるようになった

## 対応したこと

プロダクションコードを変更するためにやったこと、動作確認とか
原因解決のために対応したこと
テスト追加した

# おわりに

紆余曲折ありましたが、無事 Prisma のバージョンアップができました。
今回ハマったポイントは Prisma のタイムゾーン問題を middleware で解消している場合にのみ起こる事象ですが、参考になれば嬉しいです！

明日は、・・・

言いたいこと

- Prisma のタイムゾーン問題と 5.19.1 にあげる時の注意点

目次

- Prisma のタイムゾーン問題について

  - 一般論
    - Prisma はタイムゾーンを考慮してくれないから
    - issue が上がっている、3 年前くらい
  - アカデミー特有
    - DB に保存されてる日時は JST で保存してます
      - 歴史的背景があって、、、
    - よく使われるワークアラウンドにそって実装してる
      - Prisma にデータを渡すときともらうときに時差の辻褄を合わせるミドルウェア
    - 5.9.1 を使っていた、マイナーバージョン大きくあげることになった
      - 機能開発
    - ライブラリアップデートしたことなかった

- 起きた事象

  - queryRaw を使って Date 型を取得する処理だけ壊れた
    - この部分だけ壊れた
  - このミドルウェアを prisma のバージョンを 5.9.1 -> 5.19.1 上げると意図しない挙動になった
  - 9 時間だったのミドルウェアが怪しいと思った

- やったこと

  - リリースノートみて queryRaw 周りの変更を確認、breaking change もチェンジログ関係ありそうな変更もない　 → 収穫なし
    - Prisma のコードベース読むのは難しいので挙動で確認する、部分的だったので
  - queryRaw が実行されて値が返ってくるまでの流れ確認
    - 呼び出し -> M -> Prisma -> Pos -> Prisma -> M -> 結果（ここで顕在化）
    - 呼び出しは何も変えてない
    - ポスグレはアップデートしてない
