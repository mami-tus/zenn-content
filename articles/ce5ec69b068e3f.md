---
title: 'Prisma バージョンアップの苦労'
emoji: '🔖'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['prisma']
published: false
---

# はじめに

この記事は「Medley（メドレー） Advent Calendar 2024」5 日目の記事です！

https://qiita.com/advent-calendar/2024/medley

こんにちは、メドレーの人材プラットフォーム本部でエンジニアをしている手嶋です。
私が開発を担当している[ジョブメドレーアカデミー](https://jm-academy.jp/)では ORM に Prisma を使っています。その Prisma のバージョンアップに取り組んだ時の試行錯誤したことや学びを共有したいと思います

# Prisma とは

どういうライブラリなのか書く

# バージョンアップ時に気をつけること

今まで、本番コードで使用しているような主要なライブラリのバージョンアップをやった経験がなかったので、どのようなことに気をつけて実施すべきか調べることにしました。

Prisma は公式ドキュメントに [Upgrade guides](https://www.prisma.io/docs/orm/more/upgrade-guides) があり、バージョンアップ時の手順も記載されていて助かりました。
公式ドキュメントや、前回バージョンアップした PR、チームのメンバーにも助言をもらい、以下に注意して進めることにしました。

- リリースノートを読み、Breaking Change（破壊的変更）や、新しくリリースされた機能を確認する
- リリース直後のバージョンや、x.x.0 は新しいバグが発見される場合があるため、一つ前のバージョンにしておく
- `prisma` と `@prisma/client` どちらもバージョンを揃える必要がある

# 今回のバージョンアップで一番ハマったポイント

今回は 5.9.1（今年 2 月リリース）からのマイナーバージョンのアップデートだったのもあり、リリースノートを読む限りでは Breaking Change はありませんでした。しかし、いざバージョンを上げてテストを実行すると、日時が関わるテストの一部が失敗するようになりました。

## 起きた事象： `$queryRaw` で取得した Date 型の値に差が出た

Prisma の `$queryRaw` は生の SQL を実行する関数です。Date 型を値を取得する SQL を`$queryRaw`で実行すると、以下のように新旧バージョンで結果に差が出ました。

```typescript
const result = await prisma.$queryRaw`
  SELECT '2024-10-01 10:00:00'::timestamp
`;
console.log(result);

// 9時間マイナスされるようになった
旧バージョン: [ { timestamp: 2024-10-01T10:00:00.000Z } ]
新バージョン: [ { timestamp: 2024-10-01T01:00:00.000Z } ]
```

- 前提として？アカデミーでは Prisma のタイムゾーン問題を解決するために、ミドルウェアを使って時差補正していた（いらないと思う）
  <!-- Prisma は DB 保存時にタイムゾーンを考慮せず UTC で保存されます、よく Prisma の少し扱いにくい点として挙げられますが
  そのため[issue](https://github.com/prisma/prisma/issues/5051) で言及されている、Prisma の middleware を使って、JST と UTC の時差を吸収するため、DB に渡すデータ(where や data など)に Date 型のものが含まれていれば、それに対して 9 時間プラス、DB から出力されたデータに Date 型のものが含まれていれば、それに対して 9 時間マイナスする -->

## どのように調査したか

前提として、Prisma で日時を保存すると、DB のタイムゾーン設定に関わらず、UTC 時間 に変換されて保存されてしまいます

- ミドルウェアがおかしいとアタリをつけて、調査したこと書く
  なんでミドルウェアが怪しいと思ったのかも書く

## 何が原因だったか

調査した結果、ここがこうなってたと書く

## 対応したこと

プロダクションコードを変更するためにやったこと、動作確認とか
原因解決のために対応したこと
テスト追加した

# おわりに

紆余曲折ありましたが、無事 Prisma のバージョンアップができました。
今回ハマったポイントは Prisma のタイムゾーン問題を middleware で解消している場合にのみ起こる事象ですが、参考になれば嬉しいです！

明日は、・・・
